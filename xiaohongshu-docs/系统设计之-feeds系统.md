# 系统设计之——feeds系统

## 背景

本文介绍feed系统设计的难点及解决方案，常见的 feeds 系统有比如朋友圈，微博。

## 难点

业内用读扩散和谐扩散方式方案来解决，也称为推模式和拉模式。

### 所谓读扩散

每次用户发布动态时，动态信息只存储一份，读的时候，拉取所有关系链的动态列表做混排后输出。这种方式是读取是混排很灵活，但是存在显著的读放大。

### 所谓写扩散

每次用户发布动态时，动态信息存储多份，根据关系链决定具体几份副本。这种方式读逻辑非常简单，但是存在显著写放大，多份副本需要解决一致性问题。

## 大v发布一条动态，千万粉丝如何收到这条 feeds？

feeds 可以设置多种权限，例如私密，范围可见，特殊可见等，如何实现多权限的动态混排？

## 解决方案

### 读扩散

读扩散有如下两个业务特点：

一个特点是用户倾向于看最近信息，查看历史消息用户占比少，比如访问第一页用户占比75%，访问第二页用户占比25%，访问第三页用户占比4%。另一个特点是feed的权限灵活多变，比如好友可见，私密，固定人可见，分组可见，同时支持快速修改feed权限。

#### 如何解决读放大问题？

假设采用发布时间混排，某个用户拥有100个好友，查看首屏10个feed时，需要拉取100个好友的feed，每个好友需要拉取前10条，再做混排。查看第二页时，需要拉取100个好友的feed，每个feed拉取两页20个feed后，再混排。越往下翻，放大的越厉害。

通过额外记录用户最近发布时间戳和最近拉取进度来降低放大量。用户的最新时间戳可以用于降低首页拉取时的用户范围，比如首页10个feed，只需要取最近时间戳排前10的关系链用户，每个用户拉取10条动态再混排。然后记录用户拉取进度。

用户的拉取进度用于减少翻页时的放大，第二页也需要10个feed，通过排序上次拉取进度，找到前10个用户，每个用户拉取10条动态再混排。

### 写扩散

一般具备如下特点的场景可以考虑写扩散:

- 这个动态消息是用户的资产，例如群聊中我的聊天记录。
- 这个消息不会轻易变更权限，比如可见范围修改非常不频繁。
- 场景对对读有高时延的要求。

#### 如何解决大v的写放大问题？

头部大v有千万甚至亿级的粉丝，写扩散不现实，这部分大v可以保留一份数据，全量缓存到机器节点中，读的时候做混排。

删除feed的时候，在读取的时候用占位符解决，不建议直接过滤，不然会导致读放大。