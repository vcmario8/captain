# 系统设计之——im 系统

## 背景

春晚直播间1200wpcu参与互动，需要及时下发互动消息，同时送礼物等重要消息不能遗漏。

## 业务特点是:

- 需要及时下发消息<500ms
- 送礼物等重要消息不能遗漏
- 用户进房和退房比较频繁
- 消息需要下发给直播间所有用户
- 不同直播间火爆程度不一样，存在明显热点问题

## 难点

- 下发消息需要<500ms，不然用户体感上会产生明显的时延。
- 1000w用户同时在线时，容易把重要信息淹没，会产生用户的强烈投诉。
- 需要将消息广播给所有用户，火爆直播间明显存在热点问题。
- 1000w用户同时在线时，用户列表的统计存在很大挑战。

## 方案

针对广播和消息及时下发问题

业内有3种消息下发方案:

### 第一种，轮询技术

终端采用短连接定时轮询后台接口，看看有没有最新数据，优点是实现简单，缺点就是后台承担了大量无限请求，为了满足实时性，轮询时间一般设置很短，高并发场景下容易造成后台服务雪崩。

### 第二种，长轮询技术longpolling

在轮询技术上改进，终端采用短连接方式和后台接口通信，将超时时间设置比较长>10s，后台收到请求后hold请求，有消息时，通过通知方式重放请求返回给终端。优点是实现简单，同时降低了终端大量的无效轮询。缺点是存在惊群效应，同时互动消息多时，退化成轮询方案。wx 聊天室采用这种方式。

### 第三种是，在线push方案

终端通过websocket连接后台，定时上报心跳，后台有消息时通过push方案下发。优点是避免了所有无效请求，同时天然就存了用户在线列表信息。缺点是实现比较复杂，重要消息不能确保触达给用户。b站采用这种方式。