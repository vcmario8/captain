# 系统设计之——哨兵

## why

分布式架构中，单点问题通常通过冗余和备份来解决。比如主备模式，需要有程序监控主是否宕机，宕机后备能生升主。

我们先不考虑主备数据复制问题，单纯考虑如何识别主宕机，是一个比较麻烦的问题。

## what

把监控主宕机、并且将备提升主的程序称为哨兵。

## how

哨兵设计主要两个问题：1）哨兵单点问题？2）哨兵如何判断主故障？

### 1） 哨兵单点问题

一种方案是通过多节点抢分布锁方式解决，抢到锁的节点就是主，其余哨兵节点是备；还有一种方案是通过 zookeeper 集群来选主；分布式锁的方案比较简单。

### 2）如何判断主故障？

分布式环境下，网络隔离是非常普遍和正常的，单次心跳超时往往不能判断宕机，一般实践都是探测 3 次心跳时间超时；做的严谨一些，还得选出其他哨兵节点去再探测1 次，规避因为探测节点本身的问题。

实现上，切主是个比较高危的操作，容易造成数据丢失；比如主备还未同步完成，切主就会导致数据丢失；因此切主都需要人工介入。