# 大厂八股之——kafka 详解

## kafka 如何组织数据？

- topic，消息的抽象，任何消息都有一个 topic 归属。
- partition，1 个或多个 partirion 组成一个 topic，消费者按照 partirion 来并行消费，同一个分区内消息是有序的，就像一个队列一样。
- segment，partiron 的物理实现，是一系列文件，顺序写的文件就叫 segment，通过滚动写入避免文件过大。

## kafka 分布式技术？（就是复制和分区说清楚就行）

- 复制，利用 zk 选主做复制，维护 isr 做容灾
- 分区，按 partition 做分区，路由信息存储在 zk 比如 topic/partirion/brokerip 信息。
- 最新版本 kafka 已经去除 zk 依赖了。把 raft 算法集成到 broker 节点了。

## 为什么有这么高的性能？

### 生产者，为什么高性能？

- 批量写，通过批量写消息提升吞吐量。
- mmap，通过 mmap 将磁盘文件直接映射内存空间，减少磁盘读写的慢 io 操作，用户态直接写内存就是写必然了。
- 压缩技术，发送给 broker 前，通过压缩消息提升带宽利用率。
- 网络 io 复用，避免频繁申请 socket 资源。
- broker 收到消息后，顺序写入磁盘。

### 消费者，为什么高性能？

- pagecache 缓存技术，多个消费者读取消息的同一个缓存。
- sendfile 技术，将数据从 broker 发送给消费者，调用 api 后，切换到内核态，通过 dma 将数据从磁盘拷贝到 socket 缓冲区，直接发送出去，再回到用户态。2 次切换，至多一次内存拷贝。

### 如果传统的 read 再 write，4 次拷贝和 4 次切换

- read 时，数据从磁盘拷贝到内核缓冲区，再从内核态复制到用户态，2 次拷贝，2 次切换。
- write 时，数据从用户态复制到内核态 socket 缓冲区，再从缓冲区复制到网卡，再回到用户态，2 次拷贝，2 次切换。