# 拒绝八股！用「人话」讲透数据库复制原理

复制是分布式系统的核心命题，但很多人被教科书式八股劝退。本文用「人话」拆解技术本质，带你搞懂单主、多主、无主复制原理。

## 一、单主复制：老板带小弟，容灾靠哨兵

### 1. 核心逻辑

一个创业公司：老板（主库）负责决策（写操作），员工（从库）负责执行（读操作）。老板的所有指令（数据变更）通过公司群聊（复制通道）同步给员工。

- Redis主从复制：老板每天发工作日报（RDB快照）给员工，后续实时发微信指令（增量命令）。
- MySQL主从复制：老板用录音笔（binlog）记录所有会议内容，员工下班后听录音（重放日志）。

### 2. 容灾痛点

如果老板跑路（主库宕机），谁来接班？

- 哨兵机制：HR（哨兵集群）每隔5分钟给老板打电话，连打3次不通就开员工大会投票选新老板。
- 数据丢失风险：如果老板跑路前有未同步的指令（异步复制），员工会丢失这部分工作记录（数据不一致）。

适用场景：90%的互联网公司（如电商订单系统），需要强一致性且读多写少。

## 二、多主复制：合伙创业，冲突调解是难题

### 1. 核心逻辑

多个老板（主库）共同管理公司，比如北京和上海各有一个总部，都能发号施令。

- 冲突场景：北京老板说"商品涨价10%"，上海老板说"商品降价20%"，员工听谁的？
- 解决方案：
  - 时间戳仲裁：谁的命令时间更晚听谁的（物理时钟或逻辑时钟）。
  - 分区避冲突：华北用户归北京管，华东用户归上海管（如微信分地域部署）。

### 2. 容灾优势

上海总部停电（主库故障）？北京总部直接接管，用户无感知！但恢复后需合并两地数据（冲突处理）。

适用场景：协作工具（如飞书文档多人编辑）、多地多活系统。

## 三、无主复制：少数服从多数

### 1. 核心逻辑

没有老板，全员平等！写数据时需获得过半员工同意（Quorum机制）：

- 写入规则：5个员工中至少3人举手同意（w=3）
- 读取规则：询问3人，以多数答案为准（r=3）

典型案例：

- Cassandra：适合社交网络动态更新（如微博热搜榜），容忍短暂不一致。
- DynamoDB：电商购物车场景，优先保证可用性。

### 2. 容灾优势

任何员工请假（节点故障）都不影响系统运行，自动补发工作记录（反熵同步）。

代价：可能出现"3人说涨价、2人说降价"的分裂情况（最终一致性）。

你在项目中用过哪种复制方案？踩过哪些坑？