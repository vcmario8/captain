# 分布式存储「分区技术」拆解：掌握原理拿offer

## 面试原题：

1. 如何设计千万级用户的分布式 kv 存储？
2. 双十一如何解决订单表热点问题？
3. Redis 为什么采用 hash 分区？
4. Range 分区扩容时，数据如何保持均衡？
5. 跨分区查询如何优化性能？

## what

分区是将大数据集划分成一个个块，存储到不同机器节点上，对外提供一张大表。分区有不同的名字：mogoDB 和 Elastticsearch 上叫 shard；bigtable 中叫 tablet；hbase 中叫 region。

## why

大的数据集超出了单机能存储的极限，需要分治；调用方不用理解分治逻辑，看到的仍然是一张大表，可以无限拓展。

## how

### Hash：散列方式

每个节点公平的哈希到不同节点中，无法提供范围查询。hash 方式天然解决了大部分热点问题

### Range：像字典一样

按范围切割数据，可以提供范围查询。容易有热点问题，比如按日期分片，当天的写入就是热点。

## Q：如何解决热点问题？

A：hash 方式热点可以通过拆分多个 key 来解决，缺点是读取时要读多个 key，同时也要维护 key 对应的列表；range 方式可以选择合适的分片键，也可以选择多个 key 拼接组合分片键来缓解热点带来的嗯问题。

## Q：机器扩容的时候，数据如何搬迁？也就是分区再平衡问题。

A：对 hash 来说，rehash 需要搬迁所有数据；可以利用一致性哈希，也就是提前预分配 1024 个分区，但实际使用 100个，扩容时只需要这个节点从就近的节点中窃取数据就行了；对 range 来说就是动态分区，分区按照一定的阈值分裂或者合并，通过不停的分裂和合并，每个分区的数据会维持在一个合理水平当有机器加入时，可以将分区迁移到新机器即可。

## Q：路由表是什么？

A：分区后都要求数据库维护路由表，每个 key 对应到哪个机器节点，维护路由信息的节点称之为元数据管理节点，ha 可以通过主备全同步方式，也可以通过 zookeeper 来管理。

## Q：调用方如何访问数据？

有 3 种方式访问：1)节点转发，client 访问 a 节点，a 发现 key 不在本机，查询本地路由表，转发到正确的分片中；2） proxy 代理，proxy 查询路由表后，路由到正确的分片中；3） 调用方集成 sdk 访问，查询本地-远端路由表，路由到正确的分片中。