# 服务端面试体系——高并发

网上高并发的项目太多了，校招也会讲讲高并发，但考察的侧重不一样。校招作为知识广度来考察，社招会根据职级来要求。

## 1 校招

常见限流（计数器/漏桶/滑动窗口/令牌桶），以及应用场景对比。异步处理（利用 mq 将重的操作异步化），强依赖利用 redis 扛流量，热点问题利用 local cache 扛量，能讲清楚 lacal 和 redis 数据一致性就比较不错了。

## 2 初高阶程序员

会考察项目完备性，从端用户体验，到接入层设计，再到逻辑层的异步设计，缓存设计，存储层的拆分。要求对整个项目细节非常清楚。

对高阶程序员而言，会考察思路的复用性，实现上要对多种套路熟悉，根据业务特点选择合适的实现方式。

从思路上来说，高并发的挑战本质上流量超过了单机的性能上限，思路就是分治，分治有两个方面，一个是垂直流量的分治，存储层单 key 要拆分多 key。另一个是水平流量的分治，分层快速拒绝无效流量，最合理的系统就是减少无效流量在系统穿梭。

从实现上来说，分 key 就是分桶，会引入桶的管理以及消耗均匀性问题。快速拒绝无效流量，从端开始过滤，到接入层的拒绝黑产，到逻辑层的 bloom 过滤已经抢到的人，再到远端 redis cache 确认库存，最后才到 db。

从用户体验上来说，每个错误分支需要精心设计错误码，让用户体验无损。

## 3 架构师

需要扫除架构风险。

高并发本身不是挑战，瞬间的突变流量才是。一般线上稳定的系统是没风险的。从用户发起请求开始，这个流量会走过系统的各个服务节点，整个系统如同蜘蛛网般，某个脆弱节点被击穿后引发的级联故障才是最致命的。

如何找到脆弱节点？按照有向无环图梳理 dag，把流量经过的所有服务串起来，图的边标注流量的放大倍数，整个系统放大倍数最多的就是脆弱节点。

如何避免级联故障？三板斧，限流，不重试，超时调短（快速失败）。

最后再按照流量走一遍系统，每个失败的分支结合用户体验精心设计降级手段。

落地时还有很多条件制约，需要根据系统边界去选择成本最优的。比如小于1000的流量db是可以直接扛住，不需要各种缓存。小于10wqps的话， redis是可以直接扛住的。

如何确保线上万无一失？——冗余，饱和测试。模拟线上环境多次演习，预估100wqps，系统要压测200w 的流量。