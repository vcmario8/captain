# 数据库复制原理与灾备：从Redis到Kafka

## 面试原题：

- redis 的主从复制原理是什么？
- mysql 的主从复制原理是什么？
- kafka 的是如何做灾备恢复的？

## what

主节点和副本之间的数据同步叫复制。

## why

1）提升数据可靠性，冗余可以提供数据容灾功能；2）提升读性能，冗余的副本可以提供读。

## how

数据复制技术有三类，单主，多主，无主。

### 1 单主

有leader和follower，也称为主从复制，数据变更写主库后，有异步和同步的方式更新到从库。

为了加快同步速度，会采用类似checkpoint 机制，先同步快照，再同步变更数据。

redis 是先传输 rdb 再传输指令，mysql是传输binlog，从重放日志。

#### 如何容灾？

需要哨兵负责监听主库是否故障，如果主库发生故障，哨兵将从库可以升为主库。哨兵本身也得高可用。

如果采用异步复制，未同步的数据会丢失。如果采用同步复制，写入性能会有问题。

kafka 的做法是维护 isr，可以配置 isr 机器数，mysql 的做法的支持全同步，半同步。hbase 的目录服务器是同步更新。

### 2 多主

对比单主，有两个及以上的节点接受数据写入，然后由主库将数据复制给各自的从库。

最大的问题是冲突解决，如何解决同一行数据多个主写入？串行化，每一行加锁写入，引入分布式时钟生成唯一递增序号（google 有物理原子钟，tidb 实现了递增序号发生器），多主写入常见于在线表格的编辑，多个人同时写一行，主流做法是将处理冲突交给用户。

为了规避双向写入的麻烦，工程上往往采用数据分区，比如将用户数据设置归属地，华北的用户主节点永远在华北，写操作会转发到华北，简化成了单主复制的方式。这种方式兼顾了单主/多主的优势，大厂中比较常见，比如某信。

#### 如何容灾？

一个主故障后，将写切到另一个主即可，切换过程中用户写入会失败。等故障的主恢复后，还得处理两边数据冲突。

### 3 无主

通过多节点并行写入和 Quorum 机制保障数据一致性，总结点数为 n， 写入和读取的节点数需要满足 w+r>n，假设 5 个节点，w=3 r=3。w 和 r 可以灵活配置以满足不同的应用场景，比如 r=1 w=n，适合读多写少，r=n，w=1，适合写多读少场景。

#### 如何容灾？

节点故障后，不涉及切主，非常简单。

无主方式容灾简单，多机数据一致性复杂，需要解决数据冲突。