# 大厂八股之——https

## why

http 是明文传输，存在以下安全问题：

- 防窃听，通信过程被监听，可以查看里面的内容。
- 防篡改，通信过程，内容被修改。
- 中间人攻击，通信过程被中间人拦截，中间人作为代理转发通信双方信息。

## what

https 是解决上述安全问题的方案。

## how

- 防窃听，只要通信加密就行了。
- 防篡改，只要有消息完整性检验就行了。
- 中间人攻击，找个权威第三方颁发身份证就行了。

因此 https 的实现就是围绕这几个点来展开的。

## 原理如下：

通过权威机构的证书证明对方是合法的，然后和对方协商加密算法各自保存密钥，非对称算法加密时间长安全性高；对称加密时间短，密钥容易被爆破，实现上是对称加密通信内容，用的和提成加密协商对称算法的密钥。消息完整性就用 hash 算法实现。

为了实现上面的流程，https 对比 http，在传输层建联后，会有额外的几次 rtt 去协商这些准备工作。

## tsl1.2 是 https 的实现，流程如下：

第一个 rtt，client 发送 hello，带上 tsl 版本，加密算法集，随机数。server 返回 hello，带上选定的 tsl 版本，选定加密算法，随机数，会话 sessionid，证书，以及密钥协商需要的一些参数。

第二个 rtt，client 验证对方 ca 证书，生成对称加密密钥的参数，再利用非对称加密算法 ecdh 对密钥进行加密，server，验证消息完整性，根据密钥参数生成密钥，握手结束。

## 还有几个关注点：

- 非对称加密算法有 rsa 和 ecdh，rsa 有安全风险，而且没有完美前向兼容，tls1.3 已经禁用了。ecdh 可以做到完美前向兼容 pfs ，哪怕这次密钥泄露，以前通话内容被窃取也不会被解密。
- 对称加密算法一般用 aes-128-gcm，cbc 的有安全风险已经禁用了。
- sessionid 是用来保存密钥相关信息的，避免同一个 sesaion 中重复协商密钥。
- tsl1.3 还有 psk 机制，预协商密钥，可以做到 0rtt 握手。