# 系统设计之——唯一 ID 生成器

## why

互联网业务常见场景：订单 ID，朋友圈 FeesID 等都会要求 ID 的唯一性，更进一步的说，往往都要求订单有序性，有序性在乐观锁场景特别重要，不用严格递增，有序就行。

因此，唯一性，有序性就是系统的要求，海量场景下要求高 qps，甚至要求几百万 qps。

## what

ID 生成器就要求满足高 qps 场景，能稳定生成唯一递增的 ID，并且具备高可用，高可用就是故障自愈，并且支持横向拓展。

简而言之，需要满足唯一性，递增，高 qps。

## how

### uuid

128 位，id 随机无序。满足唯一性和高 qps，不满足递增。

### 雪花算法

64 位，依赖 ntp 时间有序，众所周知时钟递增一直是分布式难题，递增要求强的场景不靠谱。qps 可以到百万级别。满足唯一性和高 qps，不满足递增。

### 美团 leaf 方案

用户分区，预分配，改善递增的雪花算法。

#### 用户分区

给用户分段，假设分成 10 组，组内用户保持递增。

#### 预分配

为了降低到数据库的请求，分配服务定期向数据库申请固定步长，假设 10000，相当于预分配了 10000 个号，以减少对数据库的访问。分配服务是无状态的。

leaf 方案还支持改进型的雪花算法模式，将依赖的时间戳改为用 zookeeper 维护的全局递增时间戳，改善时间偏移问题。

### 微信解决方案

用户分区，预分配。用户分区和预分配，和 leaf 类似。不同点在于，分配服务是有状态的，当然性能也更优越，根据分区数量，理论上 qps 无上限。展开讲讲高可用和扩容部分。

#### 高可用

每个分区的分配服务采用主备冗余，定期心跳续约，如果超时未续约，利用哨兵服务完成切主。哨兵本身再做冗余，简单点做就是冗余多台部署，通过分布式抢锁确定主。复杂点利用 zk 选主也行。

#### 扩容

其实也简单，利用存储管理分区数和每个分区下的当前分配进度，分配服务定期读存储，拿到所在分区对应步长。扩容就是分区数增加而已，新增的分区只需要保障是最大进度即可。新扩容上的分区，只需要预热一个定时周期即可再提供服务。