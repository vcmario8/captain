# 服务端面试体系——业务数据的一致性

DB 数据的一致性、 隔离级别大家都背的很熟；这篇不是这个的。

业务数据一致性问题很少被关注，但这块日常工作中非常高频；一致性主要解决两个问题：1）主存和副本的一致性；2）ABAB 问题。

## 举个例子：多人对某个作品点赞，如何维护赞数据？

至少需要维护：赞数据、我的数据（我的赞列表、我的赞计数）、作品的数据（作品的被赞列表、作品的被赞数）

赞数据是主存，其余数据是基于这个主存构建出来的数据，假设统一叫副本。

### 1  如何保障主存和副本数据的一致性？三板斧：流水、异步、对账。

- 流水：结果数据和流水数据在一个事务中写，保障主存和流水的一致性；
- 异步：创建 consumer，订阅结果数据的变更流水，异步写后续的副本数据；
- 对账：t+1 时刻，把 [t,t+1)时刻的数据做统计对账，查缺补漏；整体就构成了主存和副本是最终一致性，t+1 时刻看 t 时刻前的数据是一致的；

### 2  如何解决ABAB 问题？cas 机制（fencing token 机制）

业务有读后写场景，非常容易出现改问题；业内解决方案就是 cas（compare and swap），也叫 fencing token 机制；数据维护一个递增版本号，每次读数据要带版本号读，写入数据时，带上版本号，如果有其他更新，写入失败重试。